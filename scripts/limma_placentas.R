## Compare expression between maternal and foetal placentas

library(limma)
library(edgeR)
library(DESeq2)
library(magrittr)
library(tidyverse)

experiment_data <-
  here::here("results/tximeta/expression_results.Rdata") %>%
  readRDS() %>%
  {DGEList(
    counts  = assays(.) %>% extract2("counts"),
    samples = colData(.),
    genes   = rowData(.),
    group   =
      colData(.) %>%
      as_tibble %>%
      transmute(group = paste(tissue, timepoint, maternal_fetal, exposure, sep = ":")) %>%
      pull(group)
  )} %>% 
  .[,.$samples$exposure != "TiO2"] %>% 
  calcNormFactors(method = "TMM")


# Subset only the placentas
placentas_data <- 
  experiment_data[, experiment_data$samples$tissue == "placenta"]

placentas_data$samples <-
  placentas_data$samples %>% 
  mutate(
    exposure = droplevels(exposure),
    tissue = tissue %>% as.factor() %>% droplevels(),
    maternal = maternal_fetal %>% as.factor(),
    timepoint = factor(x = placentas_data$samples$timepoint, levels = c(2,5,12,24))
  )

# Design matrix
# Set intercept on maternal placenta, calculate coefs for maternal and foetal separately at each stage
# Calculate response for maternal and compare with foetal

design <- 
  model.matrix(
    object = formula( ~ 0 + timepoint * exposure * maternal),
    contrasts.arg = list( 
      timepoint = "contr.treatment",
      maternal = "contr.sum", 
      exposure = "contr.sum"
    ),
    data = placentas_data$samples
  )

design_check <-
  design %>% 
  set_rownames(placentas_data$samples[ ,1])

colnames(design_check)

# Filter low expression genes and apply voom transformation

filtered_data <-
  filterByExpr(
    y = placentas_data, 
    design = design, 
    min.count = 15,
    min.total.count = 1
  ) %>% 
  placentas_data[., , keep.lib.sizes = T] %>% 
  voom(
    counts = .,
    design = design,
    lib.size = .$lib.size,
    plot = TRUE
  )

linear_model <-
  lmFit(
    object = filtered_data, 
    design = filtered_data$design
    ) %>% 
  eBayes()

write_rds(linear_model, here::here("results/limma_placentas/linear_model.Rdata"))

# Check distribution of q-values across different types of factors

q_values <- 
  linear_model %$% 
  p.value %>% 
  as_tibble(x = ., rownames = 'gene_id') %>% 
  pivot_longer(data = ., cols = -contains('gene'), names_to = 'contrast', values_to = 'p_value') %>% 
  mutate(
    q_value = fdrtool::fdrtool(x = p_value, statistic = 'pvalue') %$% qval,
    contrast = factor(
      x = contrast, 
      levels = c(
        "maternal1", 
        "exposure1",
        "exposure1:maternal1",
        paste("timepoint", c(2,5,12,24), sep = ""),
        paste("timepoint", c(2,5,12,24), ":exposure1", sep = ""),
        paste("timepoint", c(2,5,12,24), ":maternal1", sep = ""),
        paste("timepoint", c(2,5,12,24), ":exposure1", ":maternal1", sep = "")
      )),
    maternal = factor(x = grepl(pattern = "maternal", x = contrast), labels = c('other', 'maternal')),
    exposure = factor(x = grepl(pattern = "exposure", x = contrast), labels = c('other', 'exposure'))
  )

# Plot q-value distribution

q_distribution <-
  q_values %>% 
  ggplot(data = ., mapping = aes(x = q_value, fill = contrast)) +
  geom_histogram(position = 'dodge', binwidth = 0.08) +
  facet_grid(exposure ~ maternal, switch = 'y') +
  scale_fill_manual(values = viridis::viridis(16)) +
  ggtitle(label = 'q-value distribution of different placenta contrasts')

q_distribution

ggsave(filename = here::here('results/limma_placentas/q_value_distribution.pdf'), 
       width = 297, height = 210, units = 'mm')

# Zoom to focus on interaction terms

q_distribution +
  coord_cartesian(ylim = c(0,6000)) 

ggsave(filename = here::here('results/limma_placentas/q_value_distribution_zoomed.pdf'), 
       width = 297, height = 210, units = 'mm')

# Merge with fold change values and save as table
fold_change <- 
  linear_model %$%
  coefficients %>% 
  as_tibble(x = ., rownames = 'gene_id') %>% 
  pivot_longer(data = ., cols = -contains('gene'), names_to = 'contrast', values_to = 'logFC') %>% 
  mutate(
    contrast = factor(
      x = contrast, 
      levels = c(
        "maternal1", 
        "exposure1",
        "exposure1:maternal1",
        paste("timepoint", c(2,5,12,24), sep = ""),
        paste("timepoint", c(2,5,12,24), ":exposure1", sep = ""),
        paste("timepoint", c(2,5,12,24), ":maternal1", sep = ""),
        paste("timepoint", c(2,5,12,24), ":exposure1", ":maternal1", sep = "")
      )
    )
  )

result_summary_table <-
  full_join(
  x = q_values %>% dplyr::select(c('gene_id', 'contrast', 'q_value')),
  y = fold_change,
  by = c('gene_id', 'contrast')
)

write_csv(x = result_summary_table, path = here::here('results/limma_placentas/placenta_fold_change_summary.csv'))
write_rds(x = result_summary_table, path = here::here('results/limma_placentas/placenta_fold_change_summary.rds'))
