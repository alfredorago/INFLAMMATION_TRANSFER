---
title: "direct vs indirect exposure"
output: html_notebook
---

```{r load, include=FALSE}

library(tidyverse)
library(magrittr)
library(patchwork)

q_value_threshold = 0.05
log_fc_threshold = 0.25
a4_short_long = c(210, 297)

## Import DE genes from inflammation study and from our study
de_inflammation_results <-
  "results/process_lien_results/fold_change_summary.rds" %>% 
  here::here() %>% 
  read_rds() 

de_transfer_results <-
  "results/limma_compile_results/limma_results_no_maternal_contrasts.csv" %>% 
  here::here() %>% 
  read_csv() %>%
  mutate(
    timepoint = factor(x = timepoint, levels = paste0("timepoint", c(2,5,12,24)))
  ) %>% 
  {list(
    placenta = filter(
      .data = .,
      tissue == "placentas"
    ),
    lungs = filter(
      .data = ., 
      tissue == "maternal_lung"
    )
  )}
  
```

```{r prepare dataset}

# Filter only genes in both studies with FDR <= 0.05
shared_genes <-
  map(
    .x = de_transfer_results, 
    .f = ~ intersect(
      .x$mgi_symbol, 
      de_inflammation_results$mgi_symbol
    ) 
  )

filtered_de_transfer <-
  de_transfer_results %>% 
  map2(.x = ., .y = shared_genes, .f = ~ filter(.data = .x, mgi_symbol %in% .y)) %>% 
  map(.x = ., .f = select, ensembl_gene_id, mgi_symbol, q_value, log_fc = logFC, exposure, timepoint) %>% 
  map(.x = ., .f = pivot_wider, names_from = exposure, values_from = c(q_value, log_fc)) %>%
  map(.x = ., .f = select, 
      ensembl_gene_id, mgi_symbol, timepoint,
      ave_expr = log_fc_baseline, q_value = q_value_response, log_fc = log_fc_response)

filtered_de_inflammation <-
  de_inflammation_results %>% 
  select(
    mgi_symbol, q_value, ave_expr, log_fc
  ) 

shared_de <-
  map(
    .x = filtered_de_transfer,
    .f = left_join,
    y = filtered_de_inflammation,
    by = "mgi_symbol",
    suffix = c("_transfer", "_inflamed")
  )

# Filter only genes with significant logFC in at least one condition
filtered_shared_de <-
  map(
    .x = shared_de,
    .f = filter,
    (q_value_transfer < q_value_threshold) | (q_value_inflamed < q_value_threshold),
    (abs(log_fc_transfer) > log_fc_threshold) | (abs(log_fc_inflamed) > log_fc_threshold)
  ) %>% 
  map(
    .x = .,
    .f = mutate,
    de_class = case_when(
      (q_value_transfer < q_value_threshold) & (q_value_inflamed < q_value_threshold) ~ "both",
      (q_value_transfer < q_value_threshold) ~ "transfer_only",
      (q_value_inflamed < q_value_threshold) ~ "inflamed_only",
      TRUE ~ 'not_significant'),
    alpha = (log_fc_inflamed / 5) ^2 +  log_fc_transfer^2  %>% sqrt
  )

map(.x = filtered_shared_de, .f = head)
```

```{r plot inflammation, fig.width=8, fig.height=10}

placenta_plot <-
  filtered_shared_de[[1]] %>% 
  filter(timepoint == "timepoint5") %>% 
  ggplot(
    aes(
      x = log_fc_inflamed, y = log_fc_transfer, 
      label = mgi_symbol
    )
  ) +
  geom_hex(show.legend = F) +
  geom_abline(slope = 1, intercept = 0, col = 'hotpink', lty = 'dashed') +
  ggrepel::geom_text_repel(
    data = 
      filtered_shared_de[[1]] %>% 
      filter(timepoint == "timepoint5") %>% 
      filter(!grepl("Gm.*", mgi_symbol)) %>% 
      filter( 
        ( abs(log_fc_transfer) > 0.3 & abs(log_fc_inflamed) > 1.5 & de_class == 'both' ) |
          ( abs(log_fc_transfer) > 0.7 & de_class == 'transfer_only' ) |
          ( abs(log_fc_inflamed) > 4 & de_class == 'inflamed_only' )
      ), 
    aes(col = de_class), 
    fontface = "bold"
  ) +
  scale_x_continuous(name = "Response in Focal\nPlacenta Inflammation", limits = c(-3, 7.5)) +
  scale_y_continuous(name = "Response in Indirect\nPlacenta Inflammation") +
  viridis::scale_fill_viridis(
    trans = 'log', 
    breaks = scales::breaks_log(n = 5, base = 5),
    name = "number\nof genes",
    limits = c(1,600)
  ) +
  scale_color_brewer(type = 'qual') +
  theme_classic() +
  theme(legend.position = 'right')

lung_plot <- filtered_shared_de[[2]] %>% 
  filter(timepoint == "timepoint5") %>% 
  ggplot(
    aes(
      x = log_fc_inflamed, y = log_fc_transfer, 
      label = mgi_symbol
    )
  ) +
  geom_hex()+
  geom_abline(slope = 1, intercept = 0, col = 'hotpink', lty = 'dashed') +
  ggrepel::geom_text_repel(
    data = filtered_shared_de[[2]] %>% filter(timepoint == "timepoint5") %>% 
      filter(
        ( abs(log_fc_transfer) > 2.5 & abs(log_fc_inflamed) > 2.5 & de_class == 'both' ) |
          ( abs(log_fc_transfer) > 2 & de_class == 'transfer_only' ) |
          ( abs(log_fc_inflamed) > 2 & de_class == 'inflamed_only' )
      ),
    aes(col = de_class), 
    max.overlaps = 30,
    fontface = "bold",
    show.legend = F
  ) +
  scale_x_continuous(name = NULL) +
  scale_y_continuous(name = "Response in Focal\nLung Inflammation") +
  viridis::scale_fill_viridis(
    trans = 'log', 
    breaks = scales::breaks_log(n = 5, base = 5), 
    name = "number\nof genes",
    limits = c(1,600)
  ) +
  scale_color_brewer(type = 'qual') +
  theme_classic() +
  theme(legend.position = 'right')

lung_plot / placenta_plot

```

```{r plot livers}

de_livers <-
  "results/limma_compile_results/limma_results_no_maternal_contrasts.csv" %>% 
  here::here() %>% 
  read_csv() %>%
  mutate(
    timepoint = factor(x = timepoint, levels = paste0("timepoint", c(2,5,12,24)))
  ) %>% 
  filter(
    grepl("liver", tissue),
    exposure == "response"
  ) %>% 
  select(
    tissue, timepoint, ensembl_gene_id, mgi_symbol, log_fc = logFC, q_value
  ) %>% 
  pivot_wider(names_from = tissue, values_from = c(log_fc, q_value) ) %>% 
  na.exclude() %>% 
  filter(
    q_value_maternal_liver < q_value_threshold | q_value_fetal_liver < q_value_threshold,
    abs(log_fc_maternal_liver) > log_fc_threshold | abs(log_fc_fetal_liver) > log_fc_threshold
  ) %>% 
  mutate(
    de_class = case_when(
      q_value_fetal_liver < q_value_threshold & q_value_maternal_liver < q_value_threshold ~ 'both',
      q_value_fetal_liver < q_value_threshold & q_value_maternal_liver >= q_value_threshold ~ 'fetal only',
      q_value_fetal_liver >= q_value_threshold & q_value_maternal_liver < q_value_threshold ~ 'maternal only'
    )
  )

de_livers %>% 
  ggplot(
    aes(
      x = log_fc_maternal_liver,
      y = log_fc_fetal_liver
    )
  ) +
  geom_hex() +
  geom_abline(slope = 1, intercept = 0, col = 'hotpink', lty = 'dashed') +
  ggrepel::geom_text_repel(
    data = de_livers %>%
      filter(
        ( abs(log_fc_fetal_liver) > 0.25 & abs(log_fc_maternal_liver) > 1.5 & de_class == 'both' ) |
          ( abs(log_fc_fetal_liver) > 0.25 & de_class == 'fetal_only' ) |
          ( abs(log_fc_maternal_liver) > 1.5 & de_class == 'maternal_only' )
      ),
    aes(col = de_class, label = mgi_symbol), 
    max.overlaps = 30,
    fontface = "bold",
    show.legend = T
  ) +
  scale_x_continuous(name = "Response in Maternal Liver") +
  scale_y_continuous(name = "Response in Foetal Liver") +
  viridis::scale_fill_viridis(
    trans = 'log', 
    breaks = c(1,5,50,500),
    name = "number\nof genes",
    limits = c(1,700)
  ) +
  scale_color_brewer(type = 'qual') +
  theme_classic() +
  theme(legend.position = 'right')

```

